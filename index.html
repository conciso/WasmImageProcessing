<!DOCTYPE html>
<html>

<head>
    <title>WASM Image Processing</title>
</head>

<body>
    <h1>WASM Image Processing</h1>
    <canvas id="canvas"></canvas>
    <script>
        (async () => {
            const utf8Decoder = new TextDecoder('utf-8');
            const memory = new WebAssembly.Memory({ initial: 256 });

            const imports = {
                jsLog: (string, length) => {
                    const bytes = memory.buffer.slice(string, string + length);
                    console.info(utf8Decoder.decode(bytes));
                }
            };

            const importObject = {
                env: {
                    __memory_base: 0,
                    __table_base: 0,
                    memory,
                    ...imports
                }
            };

            const wasmInstance = (await WebAssembly.instantiateStreaming(fetch('image.wasm'), importObject)).instance;

            var context = document.getElementById('canvas').getContext('2d');
            var image = new Image();
            image.onload = () => {
                canvas.width = image.width;
                canvas.height = image.height;
                context.drawImage(image, 0, 0);

                const imageData = context.getImageData(0, 0, image.width, image.height);

                console.info(wasmInstance.exports);

                const wasmBufferOffset = wasmInstance.exports.getBufferOffset();
                const wasmBufferLength = wasmInstance.exports.getBufferLength();
                const wasmMemory = new Uint8ClampedArray(memory.buffer, wasmBufferOffset, wasmBufferLength);

                for (let i = 0; i < wasmMemory.length; i++) {
                    wasmMemory[i] = imageData.data[i];
                }

                wasmInstance.exports.process(imageData.width, imageData.height, imageData.data);

                context.putImageData(new ImageData(wasmMemory, image.width, image.height), 0, 0);
            };
            image.src = 'default.png';
        })();
    </script>
</body>

</html>