<!DOCTYPE html>
<html>
  <head>
    <title>WASM Image Processing</title>
  </head>

  <body>
    <h1>WASM Image Processing</h1>
    <h2 id="loading">Loading...</h2>
    <canvas id="canvas" style="display: none"></canvas>
    <p>Drag and drop a photo.</p>

    <script src="image.js"></script>
    <script>
      Module.onRuntimeInitialized = async (_) => {
        const api = {
          alloc: Module.cwrap("wasmAlloc", "number", ["number", "number"]),
          free: Module.cwrap("wasmFree", "void", ["number"]),
          process: Module.cwrap("wasmProcess", "void", ["number", "number", "number"]),
        };

        const loading = document.getElementById("loading");

        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        const image = new Image();
        image.addEventListener("load", () => {
          canvas.width = image.width;
          canvas.height = image.height;
          context.drawImage(image, 0, 0);

          const imageData = context.getImageData(0, 0, image.width, image.height);

          const wasmBufferPtr = api.alloc(image.width, image.height);

          // Copy the image into WASM memory.
          Module.HEAPU8.set(imageData.data, wasmBufferPtr);

          api.process(imageData.width, imageData.height, wasmBufferPtr);

          // Draw the image back to the canvas.
          const newImageData = new ImageData(
            new Uint8ClampedArray(Module.HEAPU8.buffer, wasmBufferPtr, image.width * image.height * 4),
            image.width,
            image.height
          );
          context.putImageData(newImageData, 0, 0);

          api.free(wasmBufferPtr);

          loading.style.display = "none";
          canvas.style.display = "block";
        });

        image.addEventListener("error", () => {
          console.error("Failed to load image.");
          loading.style.display = "none";
          canvas.style.display = "block";
        });

        image.src = "default.png";

        document.addEventListener("dragover", (event) => {
          event.preventDefault();
        });
        document.addEventListener("drop", (event) => {
          event.preventDefault();

          let file = undefined;
          if (event.dataTransfer.items && event.dataTransfer.items[0] && event.dataTransfer.items[0].kind === "file") {
            file = event.dataTransfer.items[0].getAsFile();
          } else if (event.dataTransfer.files[0]) {
            file = event.dataTransfer.files[0].name;
          }

          if (file) {
            loading.style.display = "block";
            canvas.style.display = "none";
            image.src = URL.createObjectURL(file);
          }
        });
      };
    </script>
  </body>
</html>
